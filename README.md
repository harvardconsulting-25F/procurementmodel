<div align="center">

# Procurement Model Platform

Full-stack toolkit for ingesting macro & supplier data, running the AZ bioresins price-change model, and visualizing results in a React dashboard.

</div>

---

## Repository Structure

| Path | Description |
|------|-------------|
| `az_model/` | Python data + modeling toolkit (Flask API plus ETL scripts for inputs). |
| `az_model/data/` | Generated CSV/TXT outputs (ignored by git; created when scripts run). |
| `az_model/commodities_all/` | Utility script for exporting entire World Bank pink sheet data. |
| `az_model/fx/` | FX fetch script from frankfurter.dev plus saved CSV/TXT outputs. |
| `az_ui_demo_MHEdit/` | React/Vite UI that consumes the Flask API and provides interactive weighting + insights. |
| `README.md` | (this file) full documentation. |

Each subproject is intentionally self-contained so you can run model-only workflows or only the UI if needed.

---

## Quick Start

```bash
# 1. Clone the repo (or copy from shared folder)
git clone https://github.com/harvardconsulting-25F/procurementmodel.git
cd procurementmodel

# 2. Start the backend API
cd az_model
python3 -m venv venv && source venv/bin/activate
pip install -r requirements.txt
python api.py

# 3. Start the UI (new terminal)
cd ../az_ui_demo_MHEdit
npm install
npm run dev -- --host
```

Backend defaults to `http://127.0.0.1:5001`, frontend to `http://127.0.0.1:5173`.

---

## GitHub Pages Deployment

The React UI is configured to deploy automatically to GitHub Pages via GitHub Actions.

### Automatic Deployment (Recommended)

1. **Enable GitHub Pages in your repository:**
   - Go to your repo on GitHub → **Settings** → **Pages**
   - Under **Source**, select **GitHub Actions** (not "Deploy from a branch")
   - Save the settings

2. **Push your code:**
   ```bash
   git add .
   git commit -m "Configure GitHub Pages deployment"
   git push origin main
   ```

3. **Wait for the workflow to complete:**
   - Go to **Actions** tab in your repo
   - The "Deploy to GitHub Pages" workflow will run automatically
   - Once complete, your site will be live at:
     `https://harvardconsulting-25F.github.io/procurementmodel/`

The workflow (`.github/workflows/deploy.yml`) automatically:
- Builds the React app with the correct base path (`/procurementmodel/`)
- Deploys the `dist/` folder to GitHub Pages
- Runs on every push to `main` branch

### Manual Deployment (Alternative)

If you prefer to deploy manually:

```bash
cd az_ui_demo_MHEdit
npm install
npm run build

# Copy dist/ contents to a docs/ folder in root
cd ..
mkdir -p docs
cp -r az_ui_demo_MHEdit/dist/* docs/

# Commit and push
git add docs/
git commit -m "Deploy UI to GitHub Pages"
git push origin main
```

Then in GitHub Settings → Pages, set **Source** to `/docs` folder.

### Important Notes

- **API URL**: The deployed UI will try to connect to `http://localhost:5001` by default. For production, you'll need to:
  - Deploy the Flask API separately (e.g., Heroku, Railway, Render)
  - Update `VITE_API_URL` environment variable or modify `src/App.tsx` to point to your production API URL
  - Rebuild and redeploy the UI

- **Base Path**: The Vite config is set to `/procurementmodel/` to match the repo name. If your repo name changes, update `az_ui_demo_MHEdit/vite.config.ts`.

---

## az_model (Python) Overview

### Key Files

| File | Purpose |
|------|---------|
| `api.py` | Flask app exposing `/api/health`, `/api/data/latest`, `/api/predict`, `/api/coefficients/default`. Handles weight percentages, clamps predictions ≥0, and returns detailed term breakdowns. |
| `model.py` | Standalone CLI computation of ΔP_t% using latest compiled percentage-change CSV. Saves results under `data/`. |
| `compute_percentages.py` | Reads the 4 latest input CSVs (`*_last5months.csv`), computes MoM percentage changes, writes `compiled_percentage_changes.*`. |
| `download_capital.py`, `download_labor.py`, `download_materials.py` | Fetch FRED datasets for each category and write `data/<category>_last5months.{csv,txt}`. |
| `download_energy.py` | Scrapes the World Bank commodity page for the latest monthly Excel, extracts “Natural gas, US”, and saves the last 5 months. |
| `commodities_all/commodities_all.py` | Optional script to export multiple commodities from the same Excel. |
| `fx/fx.py` | Pulls 18 months of USD→EUR/JPY/GBP rates from frankfurter.dev and plots the time series. |
| `data/` | Outputs only; regenerated by running the scripts (ignored by git). |

### Typical Workflow

1. **Gather inputs**
   ```bash
   cd az_model
   source venv/bin/activate
   python download_capital.py
   python download_labor.py
   python download_materials.py
   python download_energy.py
   ```
   (Each script prints the target series and saves CSV/TXT into `data/`.)

2. **Compute percentage changes**
   ```bash
   python compute_percentages.py
   ```
   This populates `data/compiled_percentage_changes.csv` with per-category MoM % changes.

3. **Run the analytical model**
   ```bash
   python model.py
   ```
   Produces `data/model_price_change_results.{csv,txt}` including term breakdowns and the zero-floored ΔP result.

4. **Serve the API**
   ```bash
   python api.py
   ```
   The UI (or other integrations) call this to fetch latest data and submit weighting scenarios.

### Customization Tips

* **Adding new data sources**: drop CSVs into `data/` and update `datasets` in `compute_percentages.py` or extend the downloader scripts with new FRED/World Bank endpoints.
* **Changing coefficients**: update `DEFAULT_COEFFICIENTS` in `api.py` and mirror in the front-end `DEFAULT_COEFFICIENTS`. The API accepts overrides via POST payloads.
* **Precision / clamping**: `calculate_prediction` now floors ΔP, min, and chart inputs at 0 to avoid negative price-change ranges. Adjust in `api.py` if you want symmetric distributions.

---

## az_ui_demo_MHEdit (React/Vite) Overview

### Tech Stack
* Vite + React + TypeScript
* Tailwind-ish utility classes (no separate framework)
* Recharts for probability distribution chart

### Core Components

| Component | Description |
|-----------|-------------|
| `src/App.tsx` | Main layout, orchestrates tabs (“Forecast Dashboard”, “Model Insights”), manages cost allocations, coefficient editing, API calls, and summary logic (price bands, confidence, momentum). |
| `components/CostInputs.tsx` | Collects allocation percentages (0–100) for Labor/Capital/Materials/Energy/Other. Enforces total = 100% and displays a warning otherwise. |
| `components/CoefficientEditor.tsx` | Dropdowns for High/Medium/Low coefficient levels (sign-aware). Includes “Reset to Defaults”. |
| `components/NormalDistributionChart.tsx` | Renders the truncated probability curve, confidence intervals, highlight summary cards (price band, confidence, trend), and explanation banner. |
| `components/ModelOverview.tsx` | Static narrative describing how the model works, manual weight use cases, etc. |
| `types.ts` | Shared TypeScript interfaces (cost inputs, coefficients, prediction results, summary metadata). |
| `CONNECTION_GUIDE.md` | Notes on pointing the UI at different API URLs (set `VITE_API_URL`). |

### Using the Dashboard

1. **Start both servers** (see Quick Start). The UI will call the API at `VITE_API_URL` (default `http://localhost:5001`).
2. **Load data**: Click “Load from External Data” to pull the latest MoM % changes from the API; allocations auto-normalize.
3. **Adjust allocations**: Enter custom percentages per category; totals must hit 100% to unlock predictions.
4. **Set coefficients**: Use the High/Medium/Low dropdowns or enter raw numbers (component preserves signs for lagged terms).
5. **Interpret results**: Distribution summary reports the mean % price change, whether it’s in the Low/Medium/High band, confidence (based on spread), and momentum vs. prior scenario.
6. **Explore insights tab**: Switch to “Model Insights” tab for textual explanation blocks (editable in `ModelOverview.tsx`).

### Editing & Extending

* **Change styling**: Update Tailwind classes directly in JSX. The nav tabs, cards, and alerts all use utility classes.
* **Add new tabs / charts**: Extend `TabKey` in `App.tsx`, add components, and slot them into the conditional render near the bottom.
* **New data fields**: Extend `CostInputs` / `ModelCoefficients` in `types.ts`, update `DEFAULT_COEFFICIENTS`, adjust API payloads, and add UI inputs.
* **Deploying**: Build with `npm run build` (outputs `dist/`), host via any static host (Netlify, Vercel, S3) and point `VITE_API_URL` to a deployed Flask server.

---

## Running Unit-of-Work Scripts

| Task | Command |
|------|---------|
| Fetch only capital data | `python az_model/download_capital.py` |
| Recompute percentage changes | `python az_model/compute_percentages.py` |
| Launch API with auto-reload | `python az_model/api.py` |
| Build UI for production | `cd az_ui_demo_MHEdit && npm run build` |
| Run UI tests (if added later) | `npm run test` (placeholder; configure as needed) |

---

## Editing & Contribution Guidelines

1. **Environment**: Keep Python deps isolated via `venv`, Node deps via `npm install`. Avoid committing generated folders (already ignored).
2. **API changes**: Update both backend and frontend constants (`DEFAULT_COEFFICIENTS`, types) to stay in sync.
3. **Data privacy**: `data/` holds generated economic datasets; it is ignored to avoid storing large/time-sensitive files in git.
4. **Testing**: After editing backend logic, run `python model.py` and a few manual `/api/predict` calls (curl or UI). For UI, run `npm run dev` and validate both tabs.
5. **Commits**: Develop in feature branches, squash/merge via PR when pushing to GitHub (once repo permissions are configured).

---

## Troubleshooting

| Issue | Fix |
|-------|-----|
| `ModuleNotFoundError: flask_cors` | Activate venv and `pip install -r requirements.txt`. |
| API returns 500 on `/api/predict` | Ensure `data/compiled_percentage_changes.csv` exists and cost inputs sum to 100%. |
| UI shows “allocate 100%” warning | Adjust percentages until the total equals exactly 100% (UI clamps with 0.01 tolerance). |
| Vite dev server fails with Rollup binary error | Remove `node_modules` + `package-lock.json`, rerun `npm install` (macOS Gatekeeper fix). |

---

## Deployment Notes

* **Backend**: Wrap Flask app with gunicorn/uwsgi or deploy via a managed platform (Render, Railway, Azure App Service). Set env var `PORT` as needed, expose `/api/...`.
* **Frontend**: Build static assets (`npm run build`) and host alongside the API or separately. Set `VITE_API_URL` during build (e.g., `VITE_API_URL=https://api.example.com npm run build`).
* **Data refresh cadence**: Run download + compute scripts daily/weekly, commit new CSV snapshots if you need reproducibility (or store in an object store).

---

## Need More?

* Extend the FX module to include more pairs (update `TARGETS` in `fx/fx.py`).
* Introduce authentication to the API (e.g., simple API key check) for production usage.
* Hook up automated tests (PyTest for backend, Vitest/RTL for frontend) to catch regressions when coefficients or weight logic changes.

---

Feel free to adapt the tooling for other commodities or procurement categories—the architecture keeps data ingestion, modeling, and presentation layers modular on purpose. If you have any questions, please contact us at info@harvardundergradconsulting.org

